!function(a,b){void 0===a&&void 0!==window&&(a=window),"function"==typeof define&&define.amd?define([],function(){return a.SvgEditor=b()}):"object"==typeof module&&module.exports?module.exports=b():a.SvgEditor=b()}(this,function(){function a(a,b){var c=.017453292519943295*b,d=Math.cos(c),e=Math.sin(c),f=a.x*d-a.y*e,g=a.x*e+a.y*d;return{x:parseFloat(f.toFixed(5)),y:parseFloat(g.toFixed(5))}}function b(a){var b=document.body.getBoundingClientRect(),c=a.getBoundingClientRect(),d={};return d.y=c.top-b.top,d.x=c.left-b.left,d.width=c.width,d.height=c.height,d}function c(a){var c=a.cloneNode();i.removeTransformAttribute(c,"rotate"),c.style.visibility="hidden",c.innerHTML=a.innerHTML,a.parentNode.appendChild(c);var d=b(c);return a.parentNode.removeChild(c),d}function d(a){return f(a.touches)?a.touches[0]:a}function e(a,b,c){var d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.setAttribute("viewBox","0 0 "+b+" "+c),d.innerHTML="\x3c!-- Created with SVG-edit - http://someurl.com --\x3e",d.innerHTML+=a.innerHTML;var e=new XMLSerializer,f=e.serializeToString(d);return f.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(f=f.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),f.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(f=f.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink"')),f}function f(a){return void 0!==a}var g=function(a,b){this.svgContainer=a,b=f(b)?b:{},b.size=f(b.size)?b.size:15,b.resizeButtonColor=f(b.resizeButtonColor)?b.resizeButtonColor:"black",b.closeButtonColor=f(b.closeButtonColor)?b.closeButtonColor:"red",b.rotateButtonColor=f(b.rotateButtonColor)?b.rotateButtonColor:"orange",this.styles=b,this.container=void 0,this.resizeButton=j.rect({x:0,y:0,width:b.size,height:b.size,fill:b.resizeButtonColor,id:"resizeButton"}),this.resizeButton.style.cursor="se-resize",this.closeButton=j.ellipse({x:0,y:0,width:b.size,height:b.size,fill:b.closeButtonColor,id:"closeButton"}),this.rotateButton=j.ellipse({x:0,y:0,width:b.size,height:b.size,fill:b.rotateButtonColor,id:"rotateButton"}),this.contour=h.createObject({type:"polyline",fill:"none",stroke:"black","stroke-dasharray":"5","stroke-width":"1"})};g.prototype.get=function(a){return this.container=h.createGroup(this.resizeButton,this.closeButton,this.rotateButton,this.contour),this.update(a),this.container},g.prototype.update=function(a){var b=c(a),d={width:b.width,height:b.height},e=a.getPosition(),f=i.getTransformAttribute(a,"rotate");null!=f&&i.setTransformAttribute(this.container,"rotate",f.join(" "));var g=this.styles.size/2;i.setTranslate(this.closeButton,e.x+d.width-g,e.y-g),a.resizable?i.setTranslate(this.resizeButton,e.x+d.width-g,e.y+d.height-g):i.setTranslate(this.resizeButton,-this.styles.size,-this.styles.size),a.rotatable?i.setTranslate(this.rotateButton,e.x-g+d.width/2,e.y-g):i.setTranslate(this.rotateButton,-this.styles.size,-this.styles.size);var h={x:e.x,y:e.y},j={x:e.x+d.width,y:e.y},k={x:e.x+d.width,y:e.y+d.height},l={x:e.x,y:e.y+d.height},m=h.x+","+h.y+" "+j.x+","+j.y+" "+k.x+","+k.y+" "+l.x+","+l.y+" "+h.x+","+h.y;this.contour.setAttribute("points",m)},g.prototype.hide=function(){void 0!=this.container&&(this.svgContainer.removeChild(this.container),this.container=void 0)};var h=new Object;h.createGroup=function(){for(var a=document.createElementNS("http://www.w3.org/2000/svg","g"),b=arguments.length;b--;)void 0!=arguments[b]&&a.appendChild(arguments[b]);return a},h.createObject=function(a){if(void 0!==a.type){var b=document.createElementNS("http://www.w3.org/2000/svg",a.type);delete a.type;for(var c in a)void 0!=a[c]&&("innerHTML"!=c?b.setAttribute(c,a[c]):b.innerHTML=a[c]);return b}};var i=new Object;i.getStandartAttributes=function(){return{matrix:void 0,translate:void 0,scale:void 0,rotate:void 0,skewX:void 0,skewY:void 0}},i.getTransformAttribute=function(a,b){var c=a.getAttribute("transform");if(void 0!=c){c=c.trim();var d=new RegExp("("+b+")\\(([\\d- \\-\\,\\.]+)\\)","i"),e=c.match(d);if(void 0!=e){for(var f=e[2].split(" "),g=f.length;g--;)f[g]=parseFloat(f[g]);return 1==f.length?f[0]:f}}},i.setTransformAttribute=function(a,b,c){for(var d,e=a.getAttribute("transform"),f=/([\w]+)(\([\d \-\,\.]+\))/g,g=i.getStandartAttributes();null!==(d=f.exec(e));)d[1]!=b&&(g[d[1]]=d[2]);g[b]="("+c+")";var h="";for(var j in g)void 0!=g[j]&&(h+=j+g[j]+" ");h=h.trim(),a.setAttribute("transform",h)},i.parseTransform=function(a){for(var b,c=/([\w]+)\(([\d \-\,\.]+)\)/g,d=[];null!==(b=c.exec(a));)d.push({attribute:b[1],value:b[2]});return d},i.getTransformAttributes=function(a){var b=a.getAttribute("transform");return i.parseTransform(b)},i.removeTransformAttribute=function(a,b){for(var c=this.getTransformAttributes(a),d="",e=c.length;e--;)c[e].attribute!=b&&(d+=c[e].attribute+"("+c[e].value+") ");d.trim(),a.setAttribute("transform",d)},i.addTranslate=function(a,b){var c,d=b.x,e=b.y,f=i.getTransformAttribute(a,"translate");void 0!=f?(f[0]+=d,f[1]+=e,c=f.join(" ")):c=d+" "+e,i.setTransformAttribute(a,"translate",c)},i.setTranslate=function(a,b,c){i.setTransformAttribute(a,"translate",b+" "+c)},i.getTranslate=function(a){var b=i.getTransformAttribute(a,"translate");return{x:b[0],y:b[1]}},i.addScale=function(a,b){var c,d=i.getTransformAttribute(a,"scale");void 0==d&&(d=[],d[0]=1,d[1]=1),d[0]+=b.x,d[1]+=b.y,c=d.join(" "),i.setTransformAttribute(a,"scale",c)},i.setScale=function(a,b,c){i.setTransformAttribute(a,"scale",b+" "+c)},i.getScale=function(a){var b=i.getTransformAttribute(a,"scale");return{width:b[0],height:b[1]}},i.rotate=function(a,b,c,d){i.setTransformAttribute(a,"rotate",d+" "+b+" "+c)};var j=new Object;j.__expand__=function(a,b){for(var c in b)Object.defineProperty(a,c,{value:b[c]})},j.rect=function(a){a.type="rect";var b=h.createObject(a);return j.__expand__(b,m),b},j.createFromDOM=function(a){for(var b=a.attributes,c=["hasControlElements","resizable","rotatable","snapToGrid","snapRotateToGrid"],d=c.map(function(a){return a.toLowerCase()}),e=b.length;e--;)if("true"==b[e].value){var f=d.indexOf(b[e].name);if(-1==f)continue;a[c[f]]=!!b[e].value,a.removeAttribute(b[e].name)}return j.__expand__(a,n[a.nodeName]),a},j.ellipse=function(a){a.type="ellipse",a.cx=a.x+a.width/2,a.cy=a.y+a.height/2,a.rx=a.width/2,a.ry=a.height/2,a.x=a.y=a.width=a.height=void 0;var b=h.createObject(a);return j.__expand__(b,k),b},j.path=function(a){a.type="path";var b=a.x,c=a.y,d=a.width,e=a.height;a.x=a.y=a.width=a.height=void 0;var f=h.createObject(a);return j.__expand__(f,l),f.setPosition(b,c),f.setSize(d,e),f},j.text=function(a){};var k=new Object;k.translate=function(a,b){this.setAttribute("cx",Number(this.getAttribute("cx"))+a),this.setAttribute("cy",Number(this.getAttribute("cy"))+b);var c=i.getTransformAttribute(this,"rotate");return void 0!=c&&i.setTransformAttribute(this,"rotate",c[0]+" "+(c[1]+a)+" "+(c[2]+b)),this},k.getPosition=function(){var a=Number(this.getAttribute("cx")),b=Number(this.getAttribute("cy"));return{x:a-Number(this.getAttribute("rx")),y:b-Number(this.getAttribute("ry"))}},k.getSize=function(){return{width:2*Number(this.getAttribute("rx")),height:2*Number(this.getAttribute("ry"))}},k.setPosition=function(a,b){var c=this.getPosition(),d=a-c.x,e=b-c.y;return this.translate(d,e),this},k.setSize=function(a,b){var c=this.getSize();return this.scale(a/c.width,b/c.height),this},k.scale=function(a,b){var c=Number(this.getAttribute("cx")),d=Number(this.getAttribute("cy")),e=Number(this.getAttribute("rx")),f=Number(this.getAttribute("ry")),g=e-e*a,h=f-f*b;return this.setAttribute("rx",e*a),this.setAttribute("ry",f*b),this.setAttribute("cx",c-g),this.setAttribute("cy",d-h),this},k.rotate=function(a){var b=this.getPosition(),c=this.getSize(),d=b.x+c.width/2,e=b.y+c.height/2;return i.setTransformAttribute(this,"rotate",a+" "+d+" "+e),this};var l=new Object;l.toArray=function(){for(var a=[],b=this.getAttribute("d").split(" "),c=0;c<b.length;c++)if(1!=b[c].length){var d=b[c].slice(0,1),e=b[c].slice(1).split(",").map(function(a){return Number(a)});a.push([d].concat(e))}else a.push([b[c]]);return a},l.fromArray=function(a){for(var b=0;b<a.length;b++){var c=a[b][0],d=a[b].slice(1,a[b].length);a[b]=c+d.join(",")}return this.setAttribute("d",a.join(" ")),this},l.translate=function(a,b){for(var c=this.toArray(),d=c.length;d--;)1!=c[d].length&&(c[d]=c[d].map(function(c,d){return 0==d?c:c+(d%2?a:b)}));this.fromArray(c);var e=i.getTransformAttribute(this,"rotate");return void 0!=e&&i.setTransformAttribute(this,"rotate",e[0]+" "+(e[1]+a)+" "+(e[2]+b)),this},l.scale=function(a,b){for(var c=this.getPosition(),d=this.toArray(),e=d.length;e--;)1!=d[e].length&&(d[e]=d[e].map(function(c,d){return 0==d?c:c*(d%2?a:b)}));this.fromArray(d);var f=this.getPosition(),g=f.x-c.x,h=f.y-c.y;this.translate(-g,-h);var j=i.getTransformAttribute(this,"rotate");return void 0!=j&&this.rotate(j[0]),this},l.getPosition=function(){for(var a=this.toArray(),b=void 0,c=void 0,d=0;d<a.length;d++){for(var e=a[d],f=void 0,g=void 0,h=1;h<e.length;h++)h%2?f=void 0==f?e[h]:e[h]<f?e[h]:f:g=void 0==g?e[h]:e[h]<g?e[h]:g;b=void 0==b?f:f<b?f:b,c=void 0==c?g:g<c?g:c}return{x:b,y:c}},l.getSize=function(){for(var a=this.toArray(),b=void 0,c=void 0,d=0;d<a.length;d++){for(var e=a[d],f=void 0,g=void 0,h=1;h<e.length;h++)h%2?f=void 0==f?e[h]:e[h]>f?e[h]:f:g=void 0==g?e[h]:e[h]>g?e[h]:g;b=void 0==b?f:f>b?f:b,c=void 0==c?g:g>c?g:c}var i=this.getPosition();return{width:b-i.x,height:c-i.y}},l.setPosition=function(a,b){var c=this.getPosition(),d=a-c.x,e=b-c.y;return this.translate(d,e),this},l.setSize=function(a,b){var c=this.getSize();return this.scale(a/c.width,b/c.height),this},l.rotate=function(a){var b=this.getPosition(),c=this.getSize(),d=b.x+c.width/2,e=b.y+c.height/2;return i.setTransformAttribute(this,"rotate",a+" "+d+" "+e),this};var m=new Object;m.translate=function(a,b){this.setAttribute("x",Number(this.getAttribute("x"))+a),this.setAttribute("y",Number(this.getAttribute("y"))+b);var c=i.getTransformAttribute(this,"rotate");return void 0!=c&&i.setTransformAttribute(this,"rotate",c[0]+" "+(c[1]+a)+" "+(c[2]+b)),this},m.getPosition=function(){return{x:Number(this.getAttribute("x")),y:Number(this.getAttribute("y"))}},m.getSize=function(){return{width:Number(this.getAttribute("width")),height:Number(this.getAttribute("height"))}},m.setPosition=function(a,b){return this.setAttribute("x",a),this.setAttribute("y",b),this},m.setSize=function(a,b){return this.setAttribute("width",a),this.setAttribute("height",b),this},m.scale=function(a,b){return this.setAttribute("width",Number(this.getAttribute("width"))*a),this.setAttribute("height",Number(this.getAttribute("height"))*b),this},m.rotate=function(a){var b=this.getPosition(),c=this.getSize(),d=b.x+c.width/2,e=b.y+c.height/2;return i.setTransformAttribute(this,"rotate",a+" "+d+" "+e),this};var n={rect:m,ellipse:k,path:l},o=function(a){this.svgEl=a.svg,this.cellSize=a.cellSize,this.moveStep=a.step,this.__addSvgStyles(),this.layers=[],this.layers.userCanvas=void 0,this.initUserCanvasLayer(),this.layers.grid=void 0,void 0!=this.cellSize&&this.initGridLayer(),this.layers.controlElements=void 0,this.initControlElementsLayer(),this.controlElements=new g(this.layers.controlElements,a.controlElementsStyles),this.userEvents=new p(this.cellSize,this.moveStep,this.controlElements),this.makeDraggable=this.userEvents.makeDraggable.bind(this.userEvents),this.factory=j;var b=function(a){a.target==this.svgEl&&void 0!=this.userEvents.controlElements&&this.userEvents.controlElements.hide()};this.svgEl.addEventListener("click",b.bind(this)),this.svgEl.addEventListener("touchend",b.bind(this))};o.prototype.__addSvgStyles=function(){this.svgEl.style["user-select"]="none",this.svgEl.style["-webkit-user-select"]="none",this.svgEl.style["-khtml-user-select"]="none",this.svgEl.style["-moz-user-select"]="none",this.svgEl.style["-o-user-select"]="none"},o.prototype.initUserCanvasLayer=function(){this.layers.userCanvas=this.svgEl.appendChild(h.createGroup()),this.layers.userCanvas.setAttribute("id","userCanvas")},o.prototype.initGridLayer=function(){this.layers.grid=document.createElementNS("http://www.w3.org/2000/svg","g"),this.layers.grid.setAttribute("id","grid"),this.layers.grid.style["pointer-events"]="none";for(var a=parseInt(this.svgEl.getAttribute("width")),b=parseInt(this.svgEl.getAttribute("height")),c=0;c<a;c+=this.cellSize){var d=h.createObject({type:"line",x1:c,y1:0,x2:c,y2:b,"stroke-width":1,stroke:"#333333"});this.layers.grid.appendChild(d)}for(var c=0;c<b;c+=this.cellSize){var d=h.createObject({type:"line",x1:0,y1:c,x2:a,y2:c,"stroke-width":1,stroke:"#333333"});this.layers.grid.appendChild(d)}this.svgEl.appendChild(this.layers.grid)},o.prototype.initControlElementsLayer=function(){this.layers.controlElements=h.createGroup(),this.layers.controlElements.setAttribute("id","controlElementsLayer"),this.svgEl.appendChild(this.layers.controlElements)},o.prototype.saveToSvg=function(){var a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("viewBox","0 0 "+this.svgEl.getAttribute("width")+" "+this.svgEl.getAttribute("height")),a.innerHTML+=this.layers.userCanvas.innerHTML;for(var b=this.layers.userCanvas.childNodes,c=a.childNodes,d=c.length;d--;)for(var f=Object.keys(b[d]),g=f.length;g--;)c[d].setAttribute(f[g],b[d][f[g]]);return e(a,this.svgEl.getAttribute("width"),this.svgEl.getAttribute("height"))},o.prototype.loadFromSvg=function(a){var b=document.createElement("div");b.innerHTML=a;for(var c=b.firstChild,d=c.childNodes,e=d.length;e--;)if(d[e].nodeType!==Node.COMMENT_NODE&&-1!=Object.keys(n).indexOf(d[e].nodeName)){var f=this.factory.createFromDOM(d[e]);"draggableSvg"==f.getAttribute("class")&&this.userEvents.makeDraggable(f),this.layers.userCanvas.insertBefore(f,this.layers.userCanvas.firstChild)}},o.prototype.getSvgImageLink=function(){var a=e(this.layers.userCanvas,this.svgEl.getAttribute("width"),this.svgEl.getAttribute("height"));return"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a)},o.prototype.getImageLink=function(){return new Promise(function(a,b){var c=e(this.layers.userCanvas,this.svgEl.getAttribute("width"),this.svgEl.getAttribute("height")),d="data:image/svg+xml;base64,"+btoa(c),f=document.createElement("canvas");f.setAttribute("width",parseInt(this.svgEl.getAttribute("width"))),f.setAttribute("height",parseInt(this.svgEl.getAttribute("height")));var g=f.getContext("2d"),h=new Image;h.src=d,h.onload=function(){g.drawImage(h,0,0);var b=f.toDataURL("image/png");a(b)}}.bind(this))},o.prototype.add=function(a){this.layers.userCanvas.appendChild(a),void 0!=this.userEvents.onChangeHandler&&this.userEvents.onChangeHandler()},o.prototype.getSelectedElement=function(){return this.userEvents.lastSelectedElement};var p=function(e,f,g){this.selectedElement=void 0,this.selectedElementClone=void 0,this.lastSelectedElement=void 0,this.onChangeHandler=void 0,this.onSelectHandler=void 0,this.onResizeHandler=void 0,this.onMoveHandler=void 0,this.onRotateHandler=void 0,this.dx=0,this.dy=0,this.currentX=0,this.currentY=0,this.controlElements=g,this.cellSize=e,this.baseElementSize=void 0!=this.cellSize?this.cellSize:20,this.moveStep=f,void 0!=this.cellSize&&(this.roundMoveStepNum=void 0!=this.moveStep?this.cellSize*this.moveStep:this.cellSize),this.selectElement=function(a){if(2!=a.button){this.selectedElement=a.target,this.selectedElementClone=this.selectedElement.cloneNode(),this.selectedElementClone.innerHTML=this.selectedElement.innerHTML,this.selectedElement.parentNode.appendChild(this.selectedElementClone),this.selectedElement.style.visibility="hidden",void 0!=this.controlElements&&this.controlElements.hide();var b=d(a);this.currentX=b.clientX,this.currentY=b.clientY,this.dx=0,this.dy=0,this.selectedElementClone.addEventListener("mousemove",this.moveElement),this.selectedElementClone.addEventListener("mouseout",this.deselectElement),this.selectedElementClone.addEventListener("mouseup",this.deselectElement),addEventListener("touchmove",this.moveElement),addEventListener("touchend",this.deselectElement)}}.bind(this),this.moveElement=function(a){var b=d(a);this.dx+=b.clientX-this.currentX,this.dy+=b.clientY-this.currentY,i.addTranslate(this.selectedElementClone,{x:this.dx,y:this.dy}),this.dx=0,this.dy=0,this.currentX=b.clientX,this.currentY=b.clientY}.bind(this),this.deselectElement=function(a){if(void 0!=this.selectedElementClone){if(void 0!=this.cellSize&&1==this.selectedElement.snapToGrid){var b=i.getTransformAttribute(this.selectedElementClone,"translate");void 0==b&&(b=[],b[0]=b[1]=0);var c=q(b[0],this.roundMoveStepNum),d=q(b[1],this.roundMoveStepNum);i.setTransformAttribute(this.selectedElementClone,"translate",c+" "+d)}var b=i.getTransformAttribute(this.selectedElementClone,"translate");void 0!=b&&this.selectedElement.translate(b[0],b[1]),this.selectedElement.style.visibility="visible",this.selectedElement.parentNode.removeChild(this.selectedElementClone),1==this.selectedElement.hasControlElements&&this.addControlElementsEvents(this.selectedElement),this.selectedElementClone.removeEventListener("mousemove",this.moveElement),this.selectedElementClone.removeEventListener("mouseout",this.deselectElement),this.selectedElementClone.removeEventListener("mouseup",this.deselectElement),removeEventListener("touchmove",this.moveElement),removeEventListener("touchend",this.deselectElement),this.lastSelectedElement=this.selectedElement,this.selectedElementClone=void 0,this.selectedElement=void 0,void 0!=this.onMoveHandler&&this.onMoveHandler(),void 0!=this.onSelectHandler&&this.onSelectHandler(),void 0!=this.onChangeHandler&&this.onChangeHandler()}}.bind(this),this.startResize=function(a){var b=d(a);this.currentX=b.clientX,this.currentY=b.clientY,addEventListener("mousemove",this.resize),addEventListener("touchmove",this.resize)}.bind(this),this.resize=function(b){if(2!=b.button){var c=d(b);this.dx=c.clientX-this.currentX,this.dy=c.clientY-this.currentY;var e={x:this.dx/this.lastSelectedElement.getBBox().width,y:this.dy/this.lastSelectedElement.getBBox().height},f=this.lastSelectedElement.getPosition(),g=i.getTransformAttribute(this.lastSelectedElement,"rotate");void 0!=g&&(i.removeTransformAttribute(this.lastSelectedElement,"rotate"),e=a(e,-g[0])),i.addScale(this.lastSelectedElement,e),i.setTransformAttribute(this.lastSelectedElement,"translate",f.x+" "+f.y);var h=this.lastSelectedElement.getAttribute("transform");h+=" translate("+-f.x+" "+-f.y+")",void 0!=g&&(h="rotate("+g[0]+" "+g[1]+" "+g[2]+") "+h),this.lastSelectedElement.setAttribute("transform",h),this.currentX=c.clientX,this.currentY=c.clientY,this.controlElements.update(this.lastSelectedElement),addEventListener("mouseup",this.finishResize),addEventListener("touchend",this.finishResize)}}.bind(this),this.finishResize=function(a){var c=(this.lastSelectedElement.getSize(),i.getTransformAttribute(this.lastSelectedElement,"scale")),d=this.lastSelectedElement.getSize();this.lastSelectedElement.scale(c[0],c[1]);var d=this.lastSelectedElement.getSize();if(i.removeTransformAttribute(this.lastSelectedElement,"scale"),i.removeTransformAttribute(this.lastSelectedElement,"translate"),void 0!=this.cellSize&&1==this.lastSelectedElement.snapToGrid){var d=this.lastSelectedElement.getSize(),e=q(d.width,this.roundMoveStepNum),f=q(d.height,this.roundMoveStepNum);this.lastSelectedElement.setSize(e,f),this.controlElements.update(this.lastSelectedElement)}var g=i.getTransformAttribute(this.lastSelectedElement,"rotate");if(void 0!=g){var g=i.getTransformAttribute(this.lastSelectedElement,"rotate");b(this.lastSelectedElement);this.lastSelectedElement.rotate(g[0]),this.controlElements.update(this.lastSelectedElement)}removeEventListener("mousemove",this.resize),removeEventListener("touchmove",this.resize),removeEventListener("mouseup",this.finishResize),removeEventListener("touchend",this.finishResize),void 0!=this.onResizeHandler&&this.onResizeHandler(),void 0!=this.onChangeHandler&&this.onChangeHandler()}.bind(this),this.startRotate=function(a){var b=d(a);this.currentX=b.clientX,this.currentY=b.clientY,addEventListener("mousemove",this.rotate),addEventListener("touchmove",this.rotate),addEventListener("mouseup",this.finishRotate),addEventListener("touchend",this.finishRotate)}.bind(this),this.rotate=function(a){if(2!=a.button){var b=d(a);this.dx=b.clientX-this.currentX,this.dy=b.clientY-this.currentY;var e=c(this.lastSelectedElement),f=e.x+e.width/2,g=e.y+e.height/2,h=b.clientX-f,i=b.clientY-g,j=-(270-180/Math.PI*Math.atan2(i,h));this.lastSelectedElement.rotate(j),this.controlElements.update(this.lastSelectedElement)}}.bind(this),this.finishRotate=function(a){var b=i.getTransformAttribute(this.lastSelectedElement,"rotate");if(this.lastSelectedElement.snapRotateToGrid&&void 0!=b){var c=b[0],d=q(c,45);i.setTransformAttribute(this.lastSelectedElement,"rotate",d+" "+b[1]+" "+b[2]),this.controlElements.update(this.lastSelectedElement)}removeEventListener("mousemove",this.rotate),removeEventListener("touchmove",this.rotate),removeEventListener("mouseup",this.finishRotate),removeEventListener("touchend",this.finishRotate),void 0!=this.onRotateHandler&&this.onRotateHandler(),void 0!=this.onChangeHandler&&this.onChangeHandler()}.bind(this),this.removeElement=function(a){var b=a.target.parentNode.parentNode.parentNode.getElementById("userCanvas");this.controlElements.hide(),b.removeChild(this.lastSelectedElement),this.lastSelectedElement=void 0,void 0!=this.onChangeHandler&&this.onChangeHandler()}.bind(this)};p.prototype.makeDraggable=function(a){a.setAttribute("class","draggableSvg"),a.setAttribute("style","position:relative;"),null==a.getAttribute("transform")&&a.setAttribute("transform",""),a.addEventListener("mousedown",this.selectElement),a.addEventListener("touchstart",this.selectElement)},p.prototype.addControlElementsEvents=function(a){var b=this.controlElements.get(a),c=a.parentNode.parentNode.getElementById("controlElementsLayer");this.controlElements.closeButton.addEventListener("mouseup",this.removeElement),this.controlElements.closeButton.addEventListener("touchend",this.removeElement),this.controlElements.resizeButton.addEventListener("mousedown",this.startResize),this.controlElements.resizeButton.addEventListener("touchstart",this.startResize),this.controlElements.rotateButton.addEventListener("mousedown",this.startRotate),this.controlElements.rotateButton.addEventListener("touchstart",this.startRotate),c.appendChild(b)},p.prototype.onChange=function(a){this.onChangeHandler=a},p.prototype.onSelect=function(a){this.onSelectHandler=a},p.prototype.onMove=function(a){this.onMoveHandler=a},p.prototype.onResize=function(a){this.onResizeHandler=a},p.prototype.onRotate=function(a){this.onRotateHandler=a};var q=function(a,b){return Math.round(a/b)*b};return o});